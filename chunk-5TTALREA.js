import{e as J,f as K,j as Q,k as M,l as X,n as Z,o as c,q as n,r as tt,s as et,t as st,u as ot,v as nt,w as it}from"./chunk-PIBHCUCO.js";import{B as u,Da as E,E as _,Ga as $,Ka as W,La as V,M as A,Ma as q,N as S,Oa as z,Q as m,Qa as Y,R as B,S as H,Sa as G,X as v,Y as P,aa as I,b as k,ba as h,ca as f,da as d,db as p,fa as N,ga as C,gb as L,ha as y,l as j,m as F,o as g,q as T,r as D,wa as U}from"./chunk-HKAPHFVP.js";import"./chunk-BJZWCY5R.js";var w=(()=>{class o{constructor(t,e,s){this.db=t,this.httpClient=e,this.store=s,this.messages=[],this.clientId="",this.chatRoomId=""}initCustomer(){this.clientId=localStorage.getItem("clientId"),this.clientId||(this.clientId=Math.random().toString(36).slice(-8),localStorage.setItem("clientId",this.clientId)),this.checkForChatRoom()}checkForChatRoom(){this.db.list("chatRooms",e=>e.orderByChild("clientId").equalTo(this.clientId)).snapshotChanges().pipe(u()).subscribe(e=>{e=e.filter(s=>s.payload.val()?.status==="open"),e.length?(this.chatRoomId=e[0].key,this.initChatRoom()):(console.log("no open chat room"),this.store.dispatch(c(n.waiting)))})}createChatRoom(){this.db.list("chatRooms").push({isAgent:!1,clientId:this.clientId,date:new Date().toString(),status:"open"}).then(t=>{this.chatRoomId=t.key,this.initChatRoom(!0)})}initChatRoom(t){t&&this.sendNotificationEmail(),this.store.dispatch(c(n.chatStarted));let e=0;this.db.list("chatRooms/"+this.chatRoomId).snapshotChanges().subscribe(r=>{let l=r.find(a=>a.key==="status"),O=r.find(a=>a.key==="messages");if(l?.payload.val()!=="open"||!O){this.sendMessage("Welcome, you are now chatting with an agent of ours",!0);return}Object.values(O.payload.val()).sort((a,i)=>a.time-i.time).map(a=>{let i=a;if(!this.messages.find(x=>x.time===i.time)){i.sender==="client"&&e++;let ct=new Date(i.time).toTimeString().substr(0,5),R={time:i.time,dateText:ct,sender:i.sender,isInfo:i.isInfo,message:i.message};this.messages.push(R),this.store.dispatch(Z(R))}return i})})}sendNotificationEmail(){if(p.formspreeApiUrl){let t=Math.floor(Math.random()*899999+1e5);this.httpClient.post(p.formspreeApiUrl,{email:"a"+t+"@a.com",message:"new coa customer has started chating "+t}).subscribe()}}sendMessage(t,e){let s={time:new Date().getTime(),sender:"client",message:t};e&&(s.isInfo=!0),this.db.list("chatRooms/"+this.chatRoomId+"/messages").push(s)}endChat(){this.db.list("chatRooms").update(this.chatRoomId,{status:"closed"}),this.store.dispatch(c(n.waiting)),this.chatRoomId="",this.messages=[]}static{this.\u0275fac=function(e){return new(e||o)(g(L),g(W),g(M))}}static{this.\u0275prov=j({token:o,factory:o.\u0275fac})}}return o})();var lt=(o,b)=>({"close-on":o,loading:b});function ht(o,b){if(o&1){let t=N();h(0,"app-messages",7),C("messageSent",function(s){T(t);let r=y();return D(r.insertMessage(s))}),f()}if(o&2){let t=y();I("messages",t.messages)("newMessages",t.newMessages)}}function dt(o,b){o&1&&d(0,"app-preloader",2)}var at=(()=>{class o{constructor(t,e,s,r,l){this.authService=t,this.customerService=e,this.store=s,this.router=r,this.activatedRoute=l,this.destroy$=new k,this.messages=[],this.newMessages=0,this.inputForm=new J({message:new K}),this.customerStates=n}ngOnInit(){this.activatedRoute.snapshot.queryParams["go-to-agent-panel"]&&this.router.navigate(["agent"]),this.authService.signInCheckRemote({email:p.customer.email,password:p.customer.password}),this.authService.isFbUserSingedIn.pipe(u()).subscribe(e=>{e&&this.continueToInit()})}onMessage(t){t.data.innerWidth&&(this.isParentMobile=t.data.innerWidth<992)}ngOnDestroy(){this.destroy$.next(!0),this.destroy$.unsubscribe()}onClickSwitchButton(){switch(this.customerStatus){case n.chatStarted:this.store.dispatch(c(n.minimized));break;case n.waiting:this.createChatRoom();break;case n.minimized:this.store.dispatch(c(n.chatStarted));break}}handleCustomerStatus(t){t===n.chatStarted?this.isParentMobile?parent.postMessage([{prop:"width",value:"100%"},{prop:"height",value:"100%"}],"*"):parent.postMessage([{prop:"width",value:"324px"},{prop:"height",value:"575px"}],"*"):parent.postMessage([{prop:"width",value:"70px"},{prop:"height",value:"70px"}],"*"),this.customerStatus=t}continueToInit(){this.store.select("customerState").pipe(_(this.destroy$)).subscribe(t=>{this.handleCustomerStatus(t)}),this.store.select("messages").pipe(_(this.destroy$)).subscribe(t=>{this.messages=t,this.newMessages++}),this.customerService.initCustomer()}createChatRoom(){this.customerService.createChatRoom()}insertMessage(t){this.customerService.sendMessage(t),this.inputForm.reset()}static{this.\u0275fac=function(e){return new(e||o)(m(tt),m(w),m(M),m(Y),m(z))}}static{this.\u0275cmp=B({type:o,selectors:[["app-customer"]],hostBindings:function(e,s){e&1&&C("message",function(l){return s.onMessage(l)},A)},standalone:!1,decls:9,vars:6,consts:[[3,"messages","newMessages"],[1,"switch-btn",3,"click","ngClass"],["borderColor","#ddd"],["src","assets/images/mail3.svg","alt","mail"],[1,"close-icon"],[1,"down-arrow"],[1,"box"],[3,"messageSent","messages","newMessages"]],template:function(e,s){e&1&&(v(0,ht,1,2,"app-messages",0),h(1,"button",1),C("click",function(){return s.onClickSwitchButton()}),v(2,dt,1,0,"app-preloader",2),d(3,"img",3),h(4,"span",4),d(5,"span")(6,"span"),f(),h(7,"div",5),d(8,"div",6),f()()),e&2&&(P(s.customerStatus===s.customerStates.chatStarted?0:-1),S(),I("ngClass",U(3,lt,s.customerStatus===s.customerStates.chatStarted,s.customerStatus===s.customerStates.willInit)),S(),P(s.customerStatus===s.customerStates.willInit?2:-1))},dependencies:[E,st,et],styles:[".switch-btn[_ngcontent-%COMP%]{width:55px;height:55px;border:0;border-radius:1000px;cursor:pointer;float:right;margin:13px 10px 10px 0;transition:all .6s;background:#1174c4;position:relative}.switch-btn[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:32px;transition:opacity .3s .3s;margin-top:8px}.switch-btn[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]{width:33px;display:inline-block;margin-top:-28px;vertical-align:top;float:left;margin-left:6px}.switch-btn[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{opacity:0;transition:all .1s 0s}.switch-btn[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(1){display:block;height:3px;background-color:#eee;transform:translate(-27px,-24px) rotate(45deg)}.switch-btn[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){display:block;height:3px;background-color:#eee;transform:translate(27px,-25px) rotate(-45deg)}.switch-btn[_ngcontent-%COMP%]   .down-arrow[_ngcontent-%COMP%]{display:inline-block;overflow:hidden;position:absolute;top:54px;left:17px}.switch-btn[_ngcontent-%COMP%]   .down-arrow[_ngcontent-%COMP%]   .box[_ngcontent-%COMP%]{width:21px;height:21px;background:transparent;transform:translateY(-18px) rotate(45deg) skew(10deg,10deg)}.switch-btn.close-on[_ngcontent-%COMP%]{transform:rotate(180deg)}.switch-btn.close-on[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{opacity:0;transition-delay:0s}.switch-btn.close-on[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{opacity:1;transition-delay:.3s}.switch-btn.close-on[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(1){transform:translateY(3px) rotate(45deg)}.switch-btn.close-on[_ngcontent-%COMP%]   .close-icon[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){transform:translate(0) rotate(-45deg)}.switch-btn.close-on[_ngcontent-%COMP%]   .down-arrow[_ngcontent-%COMP%]   .box[_ngcontent-%COMP%]{background:#1174c4}.switch-btn.loading[_ngcontent-%COMP%]{pointer-events:none}"]})}}return o})();var Vt=(()=>{class o{static{this.\u0275fac=function(e){return new(e||o)}}static{this.\u0275mod=H({type:o})}static{this.\u0275inj=F({providers:[w,V(q())],imports:[$,G.forChild([{path:"",component:at}]),Q,ot,X.forRoot({messages:nt,customerState:it})]})}}return o})();export{Vt as CustomerModule};
